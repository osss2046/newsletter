---
// src/components/Button.astro
import { moreLocales, themeConfig } from '@/config'
import { getNextGlobalLangPath, getNextSupportedLangPath } from '@/i18n/path'

interface Props {
  supportedLangs: string[]
}

const {
  light: { background: lightMode },
  dark: { background: darkMode },
} = themeConfig.color

const { supportedLangs } = Astro.props
const currentPath = Astro.url.pathname

const showLanguageSwitcher = moreLocales.length > 0
const nextUrl = supportedLangs.length > 0
  ? getNextSupportedLangPath(currentPath, supportedLangs)
  : getNextGlobalLangPath(currentPath)

const isEs = currentPath.startsWith('/es')
---

<!-- Usamos exactamente las clases originales para no romper el layout -->
<div
  class:list={[
  'absolute right-7.25vw top-14.6 flex gap-6 min-[823px]:max-lg:right-[calc(50vw-22rem)]',
  'lg:(fixed bottom-[min(10.27rem+1.92vw,12rem)] right-[max(5rem,calc(50vw-35rem))] top-auto w-14rem)',
  'font-title text-[11px] font-bold tracking-tighter'
]}
>
  <!-- Toggle de Idioma -->
  {showLanguageSwitcher && (
    <a href={nextUrl} class="no-underline c-secondary hover:opacity-70 transition-opacity">
      <span class={!isEs ? 'active-blue' : ''}>EN</span>
      <span class="op-30">/</span>
      <span class={isEs ? 'active-blue' : ''}>ES</span>
    </a>
  )}

  <!-- Toggle de Tema -->
  <button
    id="theme-toggle-button"
    class="bg-transparent border-none p-0 cursor-pointer c-secondary hover:opacity-70 transition-opacity flex gap-1"
  >
    <span id="label-light">LIGHT</span>
    <span class="op-30">/</span>
    <span id="label-dark">DARK</span>
  </button>
</div>

<style>
  .active-blue {
    color: #00A9FF !important;
  }
</style>

<script is:inline define:vars={{ lightMode, darkMode }}>
  // Función para actualizar los colores del toggle
  function updateThemeUI() {
    const isDark = document.documentElement.classList.contains('dark')
    const lightLabel = document.getElementById('label-light')
    const darkLabel = document.getElementById('label-dark')

    if (isDark) {
      darkLabel?.classList.add('active-blue')
      lightLabel?.classList.remove('active-blue')
    } else {
      lightLabel?.classList.add('active-blue')
      darkLabel?.classList.remove('active-blue')
    }
  }

  function applyTheme(isDark) {
    document.documentElement.classList.toggle('dark', isDark)
    updateThemeUI()
    localStorage.setItem('theme', isDark ? 'dark' : 'light')
    
    const metaThemeColor = document.head.querySelector('meta[name="theme-color"]')
    if (metaThemeColor && lightMode && darkMode) {
      metaThemeColor.setAttribute('content', isDark ? darkMode : lightMode)
    }
    document.dispatchEvent(new Event('theme-changed'))
  }

  function toggleTheme() {
    const isDark = !document.documentElement.classList.contains('dark')
    applyTheme(isDark)
  }

  // Manejador de click (Usando delegación de eventos como el original)
  function handleThemeToggleClick(e) {
    if (e.target.closest('#theme-toggle-button')) {
      if (document.startViewTransition) {
        document.documentElement.style.setProperty('view-transition-name', 'animation-theme-toggle')
        const transition = document.startViewTransition(toggleTheme)
        transition.finished.then(() => {
          document.documentElement.style.removeProperty('view-transition-name')
        })
      } else {
        toggleTheme()
      }
    }
  }

  // Inicialización única
  function init() {
    updateThemeUI()
    // Limpiar evento anterior para evitar duplicados si Astro re-ejecuta el script
    document.removeEventListener('click', handleThemeToggleClick)
    document.addEventListener('click', handleThemeToggleClick)
  }

  // Ejecutar en carga inicial y en cada cambio de página/idioma de Astro
  init()
  document.addEventListener('astro:after-swap', init)
</script>